<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WEARiT - Track Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/footer.css" />
  <link rel="stylesheet" href="/css/navbar.css" />
  <link rel="stylesheet" href="/css/order.css" />
  <link rel="stylesheet" href="/css/enhanced-order-tracking.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
  <%- include('../partials/header') %>
  
  <div class="container my-5">
    <div class="row">
      <div class="col-lg-3 mb-4">
        <%- include('../partials/navbar', { activePage: 'orders', user: user, wishlistCount: wishlistCount || 0 }) %>
      </div>
      
      <div class="col-lg-9">
        <div class="order-tracking-container">
          <!-- Breadcrumb -->
          <%- include('../partials/breadcrumb', {
              breadcrumbs: [
                  { name: 'My Account', url: '/profile', icon: 'fa-solid fa-user' },
                  { name: 'My Orders', url: '/orders', icon: 'fa-solid fa-bag-shopping' },
                  { name: 'Track Order', icon: 'fa-solid fa-truck' }
              ]
          }) %>
          
          <!-- Order Header -->
          <div class="order-header">
            <div>
              <h2 class="order-id mb-1">Order #<%= order.orderID %></h2>
              <p class="text-muted mb-0">Placed on <%= new Date(order.orderDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></p>
            </div>
            <div class="status-badge <%= getStatusClass(order.orderStatus || 'pending') %>">
              <i class="fas <%= getStatusIcon(order.orderStatus || 'pending') %> me-2"></i>
              <%= (order.orderStatus || 'pending').toUpperCase() %>
            </div>
          </div>
          
          <!-- Order Info Cards -->
          <div class="order-info-cards">
            <div class="order-info-card">
              <div class="info-card-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="info-card-label">Order Date</div>
              <div class="info-card-value">
                <%= new Date(order.orderDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
              </div>
            </div>
            
            <div class="order-info-card">
              <div class="info-card-icon">
                <i class="fas fa-credit-card"></i>
              </div>
              <div class="info-card-label">Payment Method</div>
              <div class="info-card-value">
                <%= (order.paymentMethod || order.paymentMentod) === 'COD' ? 'Cash on Delivery' : 'Online Payment' %>
              </div>
            </div>
            
            <% if (order.trackingDetails && order.trackingDetails.trackingNumber) { %>
              <div class="order-info-card">
                <div class="info-card-icon">
                  <i class="fas fa-truck"></i>
                </div>
                <div class="info-card-label">Tracking Number</div>
                <div class="info-card-value">
                  <%= order.trackingDetails.trackingNumber %>
                </div>
              </div>
            <% } %>
            
            <div class="order-info-card">
              <div class="info-card-icon">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div class="info-card-label">Total Amount</div>
              <div class="info-card-value">
                â‚¹<%= order.finalAmount ? order.finalAmount.toFixed(2) : '0.00' %>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Tracking Progress -->
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">Order Status</h5>
            </div>
            <div class="card-body">
              <div class="progress-container">
                <!-- Dynamic Progress Bar -->
                <div class="progress-bar-container">
                  <div class="progress-bar"></div>
                </div>
                
                <!-- Progress Steps -->
                <div class="progress-steps">
                  <!-- Order Placed Step -->
                  <div class="progress-step <%= isStepActive(order.orderStatus || 'pending', 'pending') ? 'active' : '' %> <%= isStepComplete(order.orderStatus || 'pending', 'pending') ? 'completed' : '' %>">
                    <div class="step-icon-container">
                      <i class="step-icon fas <%= getStatusIcon('pending') %>"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-label">Order Placed</div>
                      <% if (order.orderDate) { %>
                        <div class="step-date"><%= new Date(order.orderDate).toLocaleDateString() %></div>
                      <% } %>
                    </div>
                  </div>
                  
                  <!-- Shipped Step -->
                  <div class="progress-step <%= isStepActive(order.orderStatus || 'pending', 'shipped') ? 'active' : '' %> <%= isStepComplete(order.orderStatus || 'pending', 'shipped') ? 'completed' : '' %>">
                    <div class="step-icon-container">
                      <i class="step-icon fas <%= getStatusIcon('shipped') %>"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-label">Shipped</div>
                      <% if ((order.orderStatus === 'shipped' || isStepComplete(order.orderStatus, 'shipped')) && order.trackingDetails && order.trackingDetails.updates) { %>
                        <% const shippedUpdate = order.trackingDetails.updates.find(update => update.status === 'Order Shipped'); %>
                        <% if (shippedUpdate) { %>
                          <div class="step-date"><%= new Date(shippedUpdate.timestamp).toLocaleDateString() %></div>
                        <% } %>
                      <% } %>
                    </div>
                  </div>
                  
                  <!-- Out for Delivery Step -->
                  <div class="progress-step <%= isStepActive(order.orderStatus || 'pending', 'out for delivery') ? 'active' : '' %> <%= isStepComplete(order.orderStatus || 'pending', 'out for delivery') ? 'completed' : '' %>">
                    <div class="step-icon-container">
                      <i class="step-icon fas <%= getStatusIcon('out for delivery') %>"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-label">Out for Delivery</div>
                      <% if ((order.orderStatus === 'out for delivery' || isStepComplete(order.orderStatus, 'out for delivery')) && order.trackingDetails && order.trackingDetails.updates) { %>
                        <% const outForDeliveryUpdate = order.trackingDetails.updates.find(update => update.status === 'Out for Delivery'); %>
                        <% if (outForDeliveryUpdate) { %>
                          <div class="step-date"><%= new Date(outForDeliveryUpdate.timestamp).toLocaleDateString() %></div>
                        <% } %>
                      <% } %>
                    </div>
                  </div>
                  
                  <!-- Delivered Step -->
                  <div class="progress-step <%= isStepActive(order.orderStatus || 'pending', 'delivered') ? 'active' : '' %> <%= isStepComplete(order.orderStatus || 'pending', 'delivered') ? 'completed' : '' %>">
                    <div class="step-icon-container">
                      <i class="step-icon fas <%= getStatusIcon('delivered') %>"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-label">Delivered</div>
                      <% if (order.orderStatus === 'delivered' && order.trackingDetails && order.trackingDetails.updates) { %>
                        <% const deliveredUpdate = order.trackingDetails.updates.find(update => update.status === 'Delivered'); %>
                        <% if (deliveredUpdate) { %>
                          <div class="step-date"><%= new Date(deliveredUpdate.timestamp).toLocaleDateString() %></div>
                        <% } %>
                      <% } %>
                    </div>
                  </div>
                  
                  <!-- Return Steps (conditional) -->
                  <% if (order.orderStatus === 'return pending' || order.orderStatus === 'returned') { %>
                    <div class="progress-step <%= isStepActive(order.orderStatus, 'return pending') ? 'active' : '' %> <%= isStepComplete(order.orderStatus, 'return pending') ? 'completed' : '' %>">
                      <div class="step-icon-container">
                        <i class="step-icon fas <%= getStatusIcon('return pending') %>"></i>
                      </div>
                      <div class="step-content">
                        <div class="step-label">Return Requested</div>
                        <% if (order.trackingDetails && order.trackingDetails.updates) { %>
                          <% const returnUpdate = order.trackingDetails.updates.find(update => update.status === 'Return Requested'); %>
                          <% if (returnUpdate) { %>
                            <div class="step-date"><%= new Date(returnUpdate.timestamp).toLocaleDateString() %></div>
                          <% } %>
                        <% } %>
                      </div>
                    </div>
                    
                    <% if (order.orderStatus === 'returned') { %>
                      <div class="progress-step active completed">
                        <div class="step-icon-container">
                          <i class="step-icon fas <%= getStatusIcon('returned') %>"></i>
                        </div>
                        <div class="step-content">
                          <div class="step-label">Return Completed</div>
                          <% if (order.trackingDetails && order.trackingDetails.updates) { %>
                            <% const returnedUpdate = order.trackingDetails.updates.find(update => update.status === 'Returned'); %>
                            <% if (returnedUpdate) { %>
                              <div class="step-date"><%= new Date(returnedUpdate.timestamp).toLocaleDateString() %></div>
                            <% } else { %>
                              <div class="step-date"><%= new Date().toLocaleDateString() %></div>
                            <% } %>
                          <% } else { %>
                            <div class="step-date"><%= new Date().toLocaleDateString() %></div>
                          <% } %>
                        </div>
                      </div>
                    <% } %>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Order Items -->
          <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Order Items</h5>
              <span class="badge bg-secondary"><%= order.products.length %> item<%= order.products.length !== 1 ? 's' : '' %></span>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Product</th>
                      <th>Size</th>
                      <th>Price</th>
                      <th>Qty</th>
                      <th>Total</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (order.products && order.products.length > 0) { %>
                      <% order.products.forEach(product => { %>
                        <tr class="product-row">
                          <td>
                            <div class="product-details">
                              <% if (product.product && product.product.images && product.product.images.length > 0) { %>
                                <% const mainImage = product.product.images.find(img => img.isMain) || product.product.images[0]; %>
                                <img src="<%= mainImage ? mainImage.url : '/images/placeholder.jpg' %>" alt="<%= product.product.name %>" class="product-image">
                              <% } else { %>
                                <img src="/images/placeholder.jpg" alt="Product Image" class="product-image">
                              <% } %>
                              <div class="product-info">
                                <div class="product-name"><%= product.product ? product.product.name : 'Product' %></div>
                                <% if (product.product && product.product.brand) { %>
                                  <div class="product-brand"><%= product.product.brand %></div>
                                <% } %>
                              </div>
                            </div>
                          </td>
                          <td><%= product.variant ? product.variant.size : '-' %></td>
                          <td>â‚¹<%= product.variant ? product.variant.salePrice.toFixed(2) : '0.00' %></td>
                          <td><%= product.quantity %></td>
                          <td>â‚¹<%= product.variant ? (product.variant.salePrice * product.quantity).toFixed(2) : '0.00' %></td>
                          <td>
                            <span class="status-badge <%= getStatusClass(product.status || order.orderStatus || 'pending') %>">
                              <%= (product.status || order.orderStatus || 'pending').toUpperCase() %>
                            </span>
                          </td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="6" class="text-center py-4">No products in this order</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Shipping and Payment Info -->
          <div class="row mb-4">
            <div class="col-md-6 mb-4 mb-md-0">
              <div class="card h-100">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Shipping Address</h5>
                </div>
                <div class="card-body">
                  <% if (order.address) { %>
                    <h6 class="mb-2"><%= order.address.name %></h6>
                    <p class="mb-1"><%= order.address.address || order.address.addressLine1 %></p>
                    <% if (order.address.addressLine2) { %>
                      <p class="mb-1"><%= order.address.addressLine2 %></p>
                    <% } %>
                    <p class="mb-1"><%= order.address.city %>, <%= order.address.state %> - <%= order.address.pincode %></p>
                    <p class="mb-0">Phone: <%= order.address.mobile %></p>
                  <% } else { %>
                    <p class="mb-0">Address information not available</p>
                  <% } %>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Items Total:</span>
                    <span>â‚¹<%= order.totalAmount ? order.totalAmount.toFixed(2) : '0.00' %></span>
                  </div>
                  
                  <% if (order.discount && order.discount > 0) { %>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Discount:</span>
                      <span class="text-danger">-â‚¹<%= order.discount.toFixed(2) %></span>
                    </div>
                  <% } %>
                  
                  <% 
                    const shippingCharge = order.totalAmount > 2000 ? 0 : 50;
                  %>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Shipping:</span>
                    <span>â‚¹<%= shippingCharge.toFixed(2) %></span>
                  </div>
                  
                  <hr>
                  
                  <div class="d-flex justify-content-between fw-bold">
                    <span>Grand Total:</span>
                    <span>â‚¹<%= order.finalAmount ? order.finalAmount.toFixed(2) : '0.00' %></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tracking Timeline -->
          <% if (order.trackingDetails && order.trackingDetails.updates && order.trackingDetails.updates.length > 0) { %>
            <div class="card mb-4">
              <div class="card-header bg-white">
                <h5 class="mb-0">Tracking Updates</h5>
              </div>
              <div class="card-body">
                <div class="timeline-container">
                  <% order.trackingDetails.updates.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(update => { %>
                    <div class="timeline-item">
                      <div class="timeline-dot"></div>
                      <div class="timeline-content">
                        <span class="timeline-date">
                          <%= new Date(update.timestamp).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) %>
                          at <%= new Date(update.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                        </span>
                        <h5 class="timeline-title"><%= update.status %></h5>
                        <p class="timeline-description"><%= update.description %></p>
                        <% if (update.location) { %>
                          <div class="timeline-location">
                            <i class="fas fa-map-marker-alt"></i> <%= update.location %>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  <% }); %>
                </div>
              </div>
            </div>
          <% } %>
          
          <!-- Action Buttons -->
          <div class="order-actions">
            <% if (canCancelOrder(order.orderStatus || 'pending')) { %>
              <button class="btn btn-outline-danger cancel-order-btn" data-order-id="<%= order._id %>">
                <i class="fas fa-times-circle"></i> Cancel Order
              </button>
            <% } %>
            
            <% if (order.orderStatus === 'delivered') { %>
              <button class="btn btn-outline-warning return-order-btn" data-order-id="<%= order._id %>">
                <i class="fas fa-undo-alt"></i> Return Order
              </button>
            <% } %>
            
            <%
              let canDownloadInvoice = false;
              const paymentMethod = (order.paymentMethod || order.paymentMentod || '').toLowerCase();

              if (order.paymentStatus !== 'failed') {
                if (paymentMethod === 'cod') {
                  canDownloadInvoice = order.orderStatus === 'delivered' || order.paymentStatus === 'completed';
                } else {
                  canDownloadInvoice = order.paymentStatus === 'completed';
                }
              }
            %>

            <% if (canDownloadInvoice) { %>
              <a href="/orders/invoice/<%= order._id %>" class="btn btn-outline-dark">
                <i class="fas fa-file-invoice"></i> Download Invoice
              </a>
            <% } %>
            
            <a href="/orders/details/<%= order._id %>" class="btn btn-outline-primary">
              <i class="fas fa-info-circle"></i> View Order Details
            </a>
            
            <a href="/orders" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left"></i> Back to Orders
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <%- include('../partials/footer') %>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/enhanced-order-tracking.js"></script>
</body>
</html>
