<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title><%= product.name %> - WEARiT</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <link rel="stylesheet" href="/css/product-details.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    </head>
    <body>
        <%- include('../partials/header') %>
        <div class="container product-container mt-4">
            <div class="row">
                <div class="col-md-1 d-none d-md-block">
                    <div class="product-thumbnails">
                        <% if(product.images && product.images.length > 0) { %>
                        <% product.images.forEach((image, index) => { %>
                        <div
                            class="thumbnail <%= index === 0 ? 'active' : '' %>"
                        >
                            <img
                                src="<%= image.url %>"
                                alt="<%= product.name %> - View <%= index + 1 %>"
                                class="img-fluid thumbnail-img"
                                data-index="<%= index %>"
                            />
                        </div>
                        <% }); %> <% } else { %>
                        <div class="thumbnail active">
                            <img
                                src="/images/placeholder.jpg"
                                alt="<%= product.name %>"
                                class="img-fluid"
                            />
                        </div>
                        <% } %>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="main-product-image img-magnifier-container">
                        <img
                            src="<%= product.images && product.images.length > 0 ? 
                (product.images.find(img => img.isMain) || product.images[0]).url : 
                '/images/placeholder.jpg' %>"
                            alt="<%= product.name %>"
                            class="img-fluid main-img"
                            id="mainProductImage"
                        />
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="product-details">
                        <h1 class="product-title"><%= product.name %></h1>

                        <div class="product-rating">
                            <div class="stars">
                                <% for(let i = 1; i <= 5; i++) { %> <%
                                if(product.ratings && i <=
                                Math.floor(product.ratings.average)) { %>
                                <i class="fas fa-star"></i>
                                <% } else if(product.ratings && i - 0.5 <=
                                product.ratings.average) { %>
                                <i class="fas fa-star-half-alt"></i>
                                <% } else { %>
                                <i class="far fa-star"></i>
                                <% } %> <% } %>
                            </div>
                            <span class="rating-count">
                                <%= product.ratings ?
                                product.ratings.average.toFixed(1) : '0.0' %>/5
                                (<%= product.ratings ? product.ratings.count :
                                '0' %> reviews)
                            </span>
                        </div>

                        <div class="product-price">
                            <% if(defaultVariant && defaultVariant.varientPrice
                            > defaultVariant.salePrice) { %>
                            <h2>
                                <span class="sale-price"
                                    >₹<%= defaultVariant.salePrice %></span
                                >
                                <span class="original-price"
                                    >₹<%= defaultVariant.varientPrice %></span
                                >
                                <span class="discount-percentage">
                                    (<%= Math.round((defaultVariant.varientPrice
                                    - defaultVariant.salePrice) /
                                    defaultVariant.varientPrice * 100) %>% off)
                                </span>
                            </h2>
                            <% } else if(defaultVariant) { %>
                            <h2>₹<%= defaultVariant.salePrice %></h2>
                            <% } else { %>
                            <h2>Price unavailable</h2>
                            <% } %>
                        </div>

                        <div class="stock-status">
                            <% if(inStock) { %>
                            <span class="in-stock">In Stock</span>
                            <% } else { %>
                            <span class="out-of-stock">Out of Stock</span>
                            <% } %>
                        </div>

                        <div class="product-short-desc">
                            <p><%= product.description %></p>
                        </div>

                        <% if(product.offer) { %>
                        <div class="product-offers">
                            <div class="offer-item">
                                <div class="offer-badge">
                                    <i class="far fa-clock"></i>
                                </div>
                                <div class="offer-details">
                                    <p class="offer-title">
                                        Get <%= product.offer %>% off
                                    </p>
                                    <p class="offer-desc">
                                        Limited time offer. Use code:
                                        <strong
                                            >SPECIAL<%= product.offer %></strong
                                        >
                                    </p>
                                </div>
                            </div>
                        </div>
                        <% } %> <% if(sizeOptions && sizeOptions.length > 0) {
                        %>
                        <div class="size-selection">
                            <p>Choose Size:</p>
                            <div class="size-options">
                                <% sizeOptions.forEach(size => { %>
                                <button
                                    class="size-btn"
                                    data-size="<%= size %>"
                                >
                                    <%= size %>
                                </button>
                                <% }); %>
                            </div>
                        </div>
                        <% } %> <% if(colorOption) { %>
                        <div class="color-selection">
                            <p>Color: <%= colorOption %></p>
                        </div>
                        <% } %>

                        <div class="quantity-selection">
                            <p>Quantity:</p>
                            <div class="quantity-control">
                                <button class="qty-btn" id="decrease-qty">
                                    -
                                </button>
                                <input
                                    type="number"
                                    id="quantity"
                                    value="1"
                                    min="1"
                                    max="<%= defaultVariant ? defaultVariant.varientquatity : 1 %>"
                                />
                                <button class="qty-btn" id="increase-qty">
                                    +
                                </button>
                            </div>
                        </div>

                        <div class="cart-actions">
                            <% if(inStock) { %>
                            <button
                                class="btn-add-to-cart"
                                data-product-id="<%= product._id %>"
                            >
                                Add to Cart
                            </button>
                            <% } else { %>
                            <button class="btn-add-to-cart disabled" disabled>
                                Out of Stock
                            </button>
                            <% } %>
                            <button
                                class="btn-wishlist"
                                data-product-id="<%= product._id %>"
                            >
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-5">
                <div class="col-12">
                    <div class="product-tabs">
                        <div class="tab-headers">
                            <button class="tab-btn active" data-tab="details">
                                Product Details
                            </button>
                            <button class="tab-btn" data-tab="reviews">
                                Rating & Reviews
                            </button>
                            <button class="tab-btn" data-tab="shipping">
                                Shipping & Returns
                            </button>
                        </div>

                        <div class="tab-content active" id="details-tab">
                            <div class="product-description">
                                <h3>DESCRIPTION</h3>
                                <p><%= product.description %></p>

                                <h3>Size & Fit</h3>
                                <p>Fit - Slim Fit</p>
                                <p>Size - Model is Wearing M Size</p>

                                <h3>Wash Care</h3>
                                <p>Machine Wash</p>

                                <h3>Specifications</h3>
                                <p>Casual Wear, College Wear</p>

                                <% if(product.fabric) { %>
                                <h3>Fabric</h3>
                                <p><%= product.fabric %></p>
                                <% } %> <% if(product.tags &&
                                product.tags.length > 0) { %>
                                <h3>Tags</h3>
                                <p><%= product.tags.join(', ') %></p>
                                <% } %>

                                <p class="note">
                                    Note: The actual colour of the product may
                                    vary slightly due to photographic lighting
                                    sources or your device.
                                </p>
                                <p class="sku">
                                    SKU: <%= product.sku || product._id %>
                                </p>
                            </div>
                        </div>

                        <div class="tab-content" id="reviews-tab">
                            <div class="product-reviews">
                                <div class="overall-rating">
                                    <h3>Customer Reviews</h3>
                                    <div class="rating-summary">
                                        <div class="rating-average">
                                            <span class="big-rating">
                                                <%= product.ratings ?
                                                product.ratings.average.toFixed(1)
                                                : '0.0' %>
                                            </span>
                                            <div class="stars">
                                                <% for(let i = 1; i <= 5; i++) {
                                                %> <% if(product.ratings && i <=
                                                Math.floor(product.ratings.average))
                                                { %>
                                                <i class="fas fa-star"></i>
                                                <% } else if(product.ratings &&
                                                i - 0.5 <=
                                                product.ratings.average) { %>
                                                <i
                                                    class="fas fa-star-half-alt"
                                                ></i>
                                                <% } else { %>
                                                <i class="far fa-star"></i>
                                                <% } %> <% } %>
                                            </div>
                                            <span
                                                >Based on <%= product.ratings ?
                                                product.ratings.count : '0' %>
                                                reviews</span
                                            >
                                        </div>
                                    </div>
                                </div>

                                <p class="no-reviews">
                                    No reviews yet. Be the first to review this
                                    product!
                                </p>

                                <div class="login-to-review">
                                    <p>
                                        Please <a href="/login">login</a> to
                                        write a review.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="shipping-tab">
                            <div class="shipping-info">
                                <h3>Shipping Information</h3>
                                <p>Standard delivery: 3-5 business days</p>
                                <p>
                                    Express delivery: 1-2 business days
                                    (additional charges apply)
                                </p>

                                <h3>Return Policy</h3>
                                <p>
                                    Returns accepted within 30 days of delivery
                                </p>
                                <p>
                                    Item must be unused and in original
                                    packaging
                                </p>
                                <p>
                                    For more details, please read our
                                    <a href="/return-policy">Return Policy</a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% if(relatedProducts && relatedProducts.length > 0) { %>
            <div class="row mt-5">
                <div class="col-12">
                    <h3 class="section-title">YOU MAY ALSO LIKE</h3>
                </div>

                <% relatedProducts.forEach(related => { %>
                <div class="col-md-3 col-6">
                    <div class="similar-product">
                        <a href="/products/<%= related._id %>">
                            <div class="product-image">
                                <img
                                    src="<%= related.images && related.images.length > 0 ? related.images[0].url : '/images/placeholder.jpg' %>"
                                    alt="<%= related.name %>"
                                    class="img-fluid"
                                />
                            </div>
                            <div class="product-info">
                                <div class="product-rating">
                                    <div class="stars">
                                        <% for(let i = 1; i <= 5; i++) { %> <%
                                        if(related.ratings && i <=
                                        Math.floor(related.ratings.average)) {
                                        %>
                                        <i class="fas fa-star"></i>
                                        <% } else if(related.ratings && i - 0.5
                                        <= related.ratings.average) { %>
                                        <i class="fas fa-star-half-alt"></i>
                                        <% } else { %>
                                        <i class="far fa-star"></i>
                                        <% } %> <% } %>
                                    </div>
                                </div>
                                <h6 class="product-title">
                                    <%= related.name %>
                                </h6>
                                <p class="product-category">
                                    <%= related.categoryId &&
                                    related.categoryId.name ?
                                    related.categoryId.name : 'Category' %>
                                </p>
                                <div class="product-price-status">
                                    <span class="price"
                                        >₹<%= related.variants &&
                                        related.variants.length > 0 ?
                                        related.variants[0].salePrice : 'N/A'
                                        %></span
                                    >
                                    <% if(related.variants &&
                                    related.variants.length > 0 &&
                                    related.variants[0].varientquatity <= 5 &&
                                    related.variants[0].varientquatity > 0) { %>
                                    <span class="status">Almost Sold Out</span>
                                    <% } %>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                <% }); %>
            </div>
            <% } %> <% if(recentlyViewed && recentlyViewed.length > 0) { %>
            <div class="row mt-5">
                <div class="col-12">
                    <h3 class="section-title">RECENTLY VIEWED</h3>
                </div>

                <% recentlyViewed.forEach(viewed => { %>
                <div class="col-md-3 col-6">
                    <div class="similar-product">
                        <a href="/products/<%= viewed._id %>">
                            <div class="product-image">
                                <img
                                    src="<%= viewed.images && viewed.images.length > 0 ? viewed.images[0].url : '/images/placeholder.jpg' %>"
                                    alt="<%= viewed.name %>"
                                    class="img-fluid"
                                />
                            </div>
                            <div class="product-info">
                                <h6 class="product-title">
                                    <%= viewed.name %>
                                </h6>
                                <div class="product-price-status">
                                    <span class="price"
                                        >₹<%= viewed.variants &&
                                        viewed.variants.length > 0 ?
                                        viewed.variants[0].salePrice : 'N/A'
                                        %></span
                                    >
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                <% }); %>
            </div>
            <% } %>
        </div>
        <%- include('../partials/footer') %>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Add SweetAlert JS -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            window.productVariants = <%- JSON.stringify(product.variants || []) %>;

            document.addEventListener('DOMContentLoaded', function() {
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        this.classList.add('active');
                        const tabId = this.getAttribute('data-tab');
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                    });
                });
                const thumbnails = document.querySelectorAll('.thumbnail-img');
                const mainImg = document.getElementById('mainProductImage');

                thumbnails.forEach(thumb => {
                    thumb.addEventListener('click', function() {
                        mainImg.src = this.src;
                        thumbnails.forEach(t => t.parentElement.classList.remove('active'));
                        this.parentElement.classList.add('active');
                    });
                });
                const sizeButtons = document.querySelectorAll('.size-btn');
                let selectedSize = null;

                sizeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        sizeButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        selectedSize = this.getAttribute('data-size');
                        updateVariantAvailability();
                    });
                });
                const quantityInput = document.getElementById('quantity');
                const decreaseBtn = document.getElementById('decrease-qty');
                const increaseBtn = document.getElementById('increase-qty');

                decreaseBtn.addEventListener('click', function() {
                    const currentValue = parseInt(quantityInput.value);
                    if (currentValue > 1) {
                        quantityInput.value = currentValue - 1;
                    }
                });

                increaseBtn.addEventListener('click', function() {
                    const currentValue = parseInt(quantityInput.value);
                    const maxQty = parseInt(quantityInput.getAttribute('max'));
                    if (currentValue < maxQty) {
                        quantityInput.value = currentValue + 1;
                    }
                });
                function updateVariantAvailability() {
                    if (!selectedSize) return;

                    const variant = window.productVariants.find(v => v.size === selectedSize);
                    if (variant) {
                        quantityInput.setAttribute('max', variant.varientquatity);
                        if (parseInt(quantityInput.value) > variant.varientquatity) {
                            quantityInput.value = variant.varientquatity;
                        }
                        updatePriceDisplay(variant);
                        updateStockStatus(variant.varientquatity > 0);
                    }
                }

                function updatePriceDisplay(variant) {
                    const priceContainer = document.querySelector('.product-price');
                    if (variant.varientPrice > variant.salePrice) {
                        const discountPercentage = Math.round((variant.varientPrice - variant.salePrice) / variant.varientPrice * 100);
                        priceContainer.innerHTML = `
                            <h2>
                                <span class="sale-price">₹${variant.salePrice}</span>
                                <span class="original-price">₹${variant.varientPrice}</span>
                                <span class="discount-percentage">(${discountPercentage}% off)</span>
                            </h2>
                        `;
                    } else {
                        priceContainer.innerHTML = `<h2>₹${variant.salePrice}</h2>`;
                    }
                }

                function updateStockStatus(inStock) {
                    const stockStatus = document.querySelector('.stock-status');
                    const addToCartBtn = document.querySelector('.btn-add-to-cart');

                    if (inStock) {
                        stockStatus.innerHTML = '<span class="in-stock">In Stock</span>';
                        addToCartBtn.textContent = 'Add to Cart';
                        addToCartBtn.classList.remove('disabled');
                        addToCartBtn.disabled = false;
                    } else {
                        stockStatus.innerHTML = '<span class="out-of-stock">Out of Stock</span>';
                        addToCartBtn.textContent = 'Out of Stock';
                        addToCartBtn.classList.add('disabled');
                        addToCartBtn.disabled = true;
                    }
                }
                const addToCartBtn = document.querySelector('.btn-add-to-cart');
                if (addToCartBtn && !addToCartBtn.classList.contains('disabled')) {
                    addToCartBtn.addEventListener('click', function() {
                        if (!selectedSize) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Please select a size',
                                text: 'You need to select a size before adding to cart',
                                confirmButtonColor: '#3085d6'
                            });
                            return;
                        }

                        const productId = this.getAttribute('data-product-id');
                        const quantity = parseInt(quantityInput.value);
                        const size = selectedSize;
                        const data = {
                            productId: productId,
                            quantity: quantity,
                            size: size
                        };
                        fetch('/cart/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify(data)
                        })
                        .then(response => {
                            if (!response.ok) {
                                if (response.status === 401) {
                                    window.location.href = '/login';
                                    return Promise.reject('Unauthorized');
                                }
                                return response.json().then(data => {
                                    throw new Error(data.message || 'Something went wrong');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Added to Cart',
                                text: 'Product added to cart successfully!',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            updateCartCount(data.cartCount);
                        })
                        .catch(error => {
                            if (error === 'Unauthorized') return;
                            
                            console.error('Error adding product to cart:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: error.message || 'Failed to add product to cart. Please try again.',
                            });
                        });
                    });
                }
                const wishlistBtn = document.querySelector('.btn-wishlist');
                if (wishlistBtn) {
                    wishlistBtn.addEventListener('click', function() {
                        const productId = this.getAttribute('data-product-id');
                        fetch('/wishlist/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({ productId: productId })
                        })
                        .then(response => {
                            if (!response.ok) {
                                if (response.status === 401) {
                                    window.location.href = '/login';
                                    return Promise.reject('Unauthorized');
                                }
                                return response.json().then(data => {
                                    throw new Error(data.message || 'Something went wrong');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Added to Wishlist',
                                text: 'Product added to wishlist successfully!',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            const heartIcon = this.querySelector('i');
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas');
                        })
                        .catch(error => {
                            if (error === 'Unauthorized') return;
                            
                            console.error('Error adding product to wishlist:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: error.message || 'Failed to add product to wishlist. Please try again.',
                            });
                        });
                    });
                }
                function updateCartCount(count) {
                    const cartCountElement = document.querySelector('.cart-count');
                    if (cartCountElement) {
                        cartCountElement.textContent = count;
                    }
                }
            });
        </script>
        <script src="/js/image-magnifier.js"></script>
    </body>
</html>
