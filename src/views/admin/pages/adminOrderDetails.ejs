<!DOCTYPE html><html lang="en">    <head>        <meta charset="UTF-8" />        <meta name="viewport" content="width=device-width, initial-scale=1.0" />        <title>WEARiT - Order Details</title>        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />        <link rel="preconnect" href="https://fonts.googleapis.com">        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">        <link rel="stylesheet" href="/css/admin-navbar.css">        <link rel="stylesheet" href="/css/admin-orders.css">        <link rel="stylesheet" href="/css/admin-order-details.css">        <style>            .price-summary-card {                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);                color: white;                border-radius: 15px;                box-shadow: 0 10px 30px rgba(0,0,0,0.1);            }            .price-summary-header {                background: rgba(255,255,255,0.1);                border-radius: 15px 15px 0 0;                backdrop-filter: blur(10px);            }            .summary-row {                display: flex;                justify-content: space-between;                align-items: center;                padding: 0.75rem 0;                border-bottom: 1px solid rgba(255,255,255,0.1);            }            .summary-row:last-child {                border-bottom: none;            }            .summary-row.total {                background: rgba(255,255,255,0.1);                margin: 0 -1.5rem;                padding: 1rem 1.5rem;                border-radius: 0 0 15px 15px;                font-weight: 600;                font-size: 1.1rem;            }            .summary-label {                font-weight: 500;                opacity: 0.9;            }            .summary-value {                font-weight: 600;            }            .discount-value {                color: #4ade80 !important;            }            .coupon-badge {                background: rgba(255,255,255,0.2);                color: white;                padding: 0.25rem 0.5rem;                border-radius: 0.5rem;                font-size: 0.75rem;                margin-left: 0.5rem;            }            .free-shipping {                color: #4ade80 !important;                font-weight: 600;            }            .price-breakdown-item {                background: rgba(255,255,255,0.05);                border-radius: 8px;                padding: 0.75rem;                margin-bottom: 0.5rem;            }            .update-animation {                animation: highlightUpdate 2s ease-in-out;            }            @keyframes highlightUpdate {                0% { background-color: rgba(255,255,255,0.2); }                50% { background-color: rgba(255,255,255,0.3); }                100% { background-color: transparent; }            }            .variant-identifier {                font-size: 0.75rem;                color: #6c757d;                font-style: italic;            }            .product-variant-row {                border-left: 3px solid transparent;                transition: border-color 0.3s ease;            }            .product-variant-row:hover {                border-left-color: #0d6efd;            }            .variant-status-badge {                position: relative;            }            .variant-status-badge::after {                content: attr(data-variant);                position: absolute;                bottom: -1px;                right: -1px;                background: rgba(0,0,0,0.7);                color: white;                font-size: 0.6rem;                padding: 1px 3px;                border-radius: 2px;                font-weight: normal;            }        </style>    </head>    <body>        <% if (typeof admin !== 'undefined') { %>            <%- include('../partials/navbar', {activePage: 'orders'}) %>        <% } else { %>            <header class="admin-header">                <div class="container-fluid">                    <div class="row">                        <div class="col-12">                            <h1>WEARiT Admin</h1>                        </div>                    </div>                </div>            </header>        <% } %>        <main class="admin-main">            <div class="container-fluid py-4">                <% if (locals.success_msg && success_msg.length > 0) { %>                    <div class="alert alert-success alert-dismissible fade show" role="alert">                        <%= success_msg %>                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>                    </div>                <% } %>                <% if (locals.error_msg && error_msg.length > 0) { %>                    <div class="alert alert-danger alert-dismissible fade show" role="alert">                        <%= error_msg %>                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>                    </div>                <% } %>                <div class="page-header d-flex justify-content-between align-items-center mb-4">                    <div>                        <h2 class="page-title mb-1">Order #<%= order.orderID %></h2>                        <nav aria-label="breadcrumb">                            <ol class="breadcrumb mb-0">                                <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>                                <li class="breadcrumb-item"><a href="/admin/orders">Orders</a></li>                                <li class="breadcrumb-item active" aria-current="page">Order Details</li>                            </ol>                        </nav>                    </div>                    <div class="d-flex gap-2">                        <a href="/admin/orders" class="btn btn-outline-secondary">                            <i class="fas fa-arrow-left me-2"></i>Back                        </a>                        <%                          let canDownloadInvoice = false;                          const paymentMethod = (order.paymentMethod || order.paymentMentod || '').toLowerCase();                          if (order.paymentStatus !== 'failed') {                            if (paymentMethod === 'cod') {                              canDownloadInvoice = order.orderStatus === 'delivered' || order.paymentStatus === 'completed';                            } else {                              canDownloadInvoice = order.paymentStatus === 'completed';                            }                          }                        %>                        <% if (canDownloadInvoice) { %>                          <a href="/admin/orders/<%= order._id %>/invoice" class="btn btn-primary" download>                              <i class="fas fa-file-invoice me-2"></i>Download Invoice                          </a>                        <% } else { %>                          <button class="btn btn-secondary" disabled title="Invoice not available - <%=                            order.paymentStatus === 'failed' ? 'Payment failed' :                            order.paymentStatus === 'pending' ? 'Payment pending' :                            paymentMethod === 'cod' ? 'COD invoice available after delivery' :                            'Payment not completed' %>">                              <i class="fas fa-file-invoice me-2"></i>Invoice Not Available                          </button>                        <% } %>                        <% if (order.orderStatus !== 'cancelled' && order.orderStatus !== 'delivered') { %>                            <button class="btn btn-danger cancel-order-btn" data-order-id="<%= order._id %>">                                <i class="fas fa-times me-2"></i>Cancel Order                            </button>                        <% } %>                    </div>                </div>                <div class="order-status-banner mb-4">                    <div class="status-badge status-<%= order.orderStatus.toLowerCase().replace(/\s+/g, '-') %>">                        <i class="fas fa-<%=        order.orderStatus === 'delivered' ? 'check-circle' :        order.orderStatus === 'cancelled' ? 'times-circle' :        order.orderStatus === 'shipped' ? 'shipping-fast' :        order.orderStatus === 'out for delivery' ? 'truck' :        order.orderStatus === 'returned' ? 'undo-alt' :        order.orderStatus === 'return pending' ? 'exchange-alt' :        'clock'    %> me-2"></i>                        <%= order.orderStatus.charAt(0).toUpperCase() + order.orderStatus.slice(1) %>                    </div>                    <div class="order-date">                        <i class="far fa-calendar-alt me-2"></i>                        Ordered on <%= new Date(order.createdAt).toLocaleDateString('en-US', { day: '2-digit', month: 'long', year: 'numeric' }) %>                    </div>                    <div class="payment-method">                        <i class="fas fa-credit-card me-2"></i>                        <%= order.paymentMethod %>                    </div>                </div>                <div class="row">                    <div class="col-lg-4 mb-4">                        <div class="card mb-4 shadow-sm">                            <div class="card-header bg-white">                                <h5 class="mb-0">Customer Information</h5>                            </div>                            <div class="card-body">                                <div class="customer-info">                                    <div class="info-item">                                        <div class="info-icon">                                            <i class="fas fa-user"></i>                                        </div>                                        <div class="info-content">                                            <div class="info-label">Name</div>                                            <div class="info-value"><%= order.user?.name ?? 'Unknown user' %></div>                                        </div>                                    </div>                                    <div class="info-item">                                        <div class="info-icon">                                            <i class="fas fa-envelope"></i>                                        </div>                                        <div class="info-content">                                            <div class="info-label">Email</div>                                            <div class="info-value"><%= order.user?.email ?? 'N/A' %></div>                                        </div>                                    </div>                                    <div class="info-item">                                        <div class="info-icon">                                            <i class="fas fa-phone"></i>                                        </div>                                        <div class="info-content">                                            <div class="info-label">Phone</div>                                            <div class="info-value"><%= order.user?.mobile ?? 'N/A' %></div>                                        </div>                                    </div>                                </div>                            </div>                        </div>                        <div class="card mb-4 shadow-sm">                            <div class="card-header bg-white">                                <h5 class="mb-0">Shipping Address</h5>                            </div>                            <div class="card-body">                                <div class="address-info">                                    <div class="info-item">                                        <div class="info-icon">                                            <i class="fas fa-map-marker-alt"></i>                                        </div>                                        <div class="info-content">                                            <% if (order.address && (order.address.name || order.address.address)) { %>                                                <div class="address-name"><%= order.address.name || 'Unknown' %></div>                                                <div class="address-line"><%= order.address.address || 'Unknown address' %></div>                                                <div class="address-line"><%= order.address.city || 'Unknown' %>, <%= order.address.state || 'Unknown' %> <%= order.address.pincode || 'Unknown' %></div>                                                <div class="address-phone"><%= order.address.mobile || 'Not provided' %></div>                                            <% } else { %>                                                <div class="text-muted">                                                    <i class="fas fa-exclamation-triangle me-2"></i>                                                    Unknown address - Address information is no longer available                                                </div>                                            <% } %>                                        </div>                                    </div>                                </div>                            </div>                        </div>                        <div class="card price-summary-card mb-4 shadow-lg" id="priceSummaryCard">                            <div class="card-header price-summary-header">                                <h5 class="mb-0 text-white">                                    <i class="fas fa-calculator me-2"></i>                                    Price Summary                                </h5>                                <small class="text-white-50">                                    <span id="activeProductsCount"><%= orderSummary.activeProductsCount %></span> of                                    <span id="totalProductsCount"><%= orderSummary.totalProductsCount %></span> items active                                </small>                            </div>                            <div class="card-body">                                <div class="summary-row">                                    <span class="summary-label">                                        <i class="fas fa-shopping-bag me-2"></i>                                        Items Subtotal:                                    </span>                                    <span class="summary-value" id="regularTotal">₹<%= orderSummary.regularTotal.toFixed(2) %></span>                                </div>                                <% if (orderSummary.productDiscount > 0) { %>                                <div class="summary-row">                                    <span class="summary-label">                                        <i class="fas fa-tag me-2"></i>                                        Product Discount:                                    </span>                                    <span class="summary-value discount-value" id="productDiscount">-₹<%= orderSummary.productDiscount.toFixed(2) %></span>                                </div>                                <% } %>                                <div class="summary-row">                                    <span class="summary-label">                                        <i class="fas fa-receipt me-2"></i>                                        Items Total:                                    </span>                                    <span class="summary-value" id="itemsTotal">₹<%= orderSummary.itemsTotal.toFixed(2) %></span>                                </div>                                <% if (orderSummary.couponDiscount > 0) { %>                                <div class="summary-row">                                    <span class="summary-label">                                        <i class="fas fa-ticket-alt me-2"></i>                                        Coupon Discount:                                        <% if (orderSummary.couponInfo) { %>                                            <span class="coupon-badge"><%= orderSummary.couponInfo.code %></span>                                        <% } %>                                    </span>                                    <span class="summary-value discount-value" id="couponDiscount">-₹<%= orderSummary.couponDiscount.toFixed(2) %></span>                                </div>                                <% } %>                                <div class="summary-row">                                    <span class="summary-label">                                        <i class="fas fa-shipping-fast me-2"></i>                                        Shipping:                                        <% if (orderSummary.itemsTotal >= 1000) { %>                                            <small class="text-white-50">(Free for orders ≥₹1000)</small>                                        <% } else { %>                                            <small class="text-white-50">(₹200 for orders <₹1000)</small>                                        <% } %>                                    </span>                                    <span class="summary-value <%= orderSummary.shippingCharge === 0 ? 'free-shipping' : '' %>" id="shippingCharge">                                        <% if (orderSummary.shippingCharge === 0) { %>                                            Free                                        <% } else { %>                                            ₹<%= orderSummary.shippingCharge.toFixed(2) %>                                        <% } %>                                    </span>                                </div>                                <div class="summary-row total">                                    <span class="summary-label">                                        <i class="fas fa-money-check-alt me-2"></i>                                        Grand Total:                                    </span>                                    <span class="summary-value" id="grandTotal">₹<%= orderSummary.grandTotal.toFixed(2) %></span>                                </div>                                <div class="mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">                                    <div class="d-flex justify-content-between align-items-center">                                        <span class="summary-label">                                            <i class="fas fa-credit-card me-2"></i>                                            Payment Method:                                        </span>                                        <span class="summary-value">                                            <%= order.paymentMethod === 'COD' ? 'Cash on Delivery' :                                                order.paymentMethod === 'wallet' ? 'Wallet' :                                                order.paymentMethod === 'paypal' ? 'PayPal' : 'Online Payment' %>                                        </span>                                    </div>                                    <% if (order.paymentMethod === 'COD') { %>                                        <small class="text-white-50 d-block mt-1">                                            <i class="fas fa-info-circle me-1"></i>                                            COD available for orders under ₹1000                                        </small>                                    <% } %>                                </div>                            </div>                        </div>                    </div>                    <div class="col-lg-8">                        <div class="card mb-4 shadow-sm">                            <div class="card-header bg-white d-flex justify-content-between align-items-center">                                <h5 class="mb-0">Order Items</h5>                                <span class="badge bg-secondary"><%= order.products.length %> items</span>                            </div>                            <div class="card-body p-0">                                <div class="table-responsive">                                    <table class="table table-hover mb-0">                                        <thead class="table-light">                                            <tr>                                                <th scope="col" style="width: 45%">Product</th>                                                <th scope="col">Size</th>                                                <th scope="col">Price</th>                                                <th scope="col">Qty</th>                                                <th scope="col">Total</th>                                                <th scope="col">Status</th>                                                <th scope="col">Action</th>                                            </tr>                                        </thead>                                        <tbody>                                            <% order.products.forEach((item, index) => { %>                                            <tr class="product-variant-row <%= item.isActive ? '' : 'table-secondary' %>"                                                data-product-id="<%= item.product._id %>"                                                data-variant-index="<%= index %>"                                                data-variant-size="<%= item.variant?.size || 'N/A' %>">                                                <td>                                                    <div class="d-flex align-items-center">                                                        <% if (item.product && item.product.images && item.product.images.length > 0) { %>                                                            <img src="<%= item.product.images[0].url %>"                                                                alt="<%= item.product.name %>"                                                                class="product-img me-3"                                                                width="50" height="50">                                                        <% } else { %>                                                            <img src="/images/placeholder.jpg"                                                                alt="Product Deleted"                                                                class="product-img me-3 opacity-50"                                                                width="50" height="50">                                                        <% } %>                                                        <div>                                                            <h6 class="mb-0">                                                                <%= item.product ? item.product.name : 'Product Deleted' %>                                                                <% if (!item.product) { %>                                                                    <span class="badge bg-secondary ms-2">Deleted</span>                                                                <% } %>                                                            </h6>                                                            <small class="text-muted"><%= item.product ? (item.product.color || 'N/A') : 'N/A' %></small>                                                            <div class="variant-identifier">                                                                Variant #<%= index + 1 %> | ID: <%= item.uniqueId %>                                                            </div>                                                            <% if (!item.isActive) { %>                                                                <small class="text-danger d-block">                                                                    <i class="fas fa-exclamation-triangle me-1"></i>                                                                    Excluded from totals                                                                </small>                                                            <% } %>                                                        </div>                                                    </div>                                                </td>                                                <td>                                                    <span class="badge bg-light text-dark">                                                        <%= item.variant?.size || 'N/A' %>                                                    </span>                                                </td>                                                <td>                                                    <% if (item.regularPrice > item.salePrice) { %>                                                        <span class="text-decoration-line-through text-muted small">₹<%= item.regularPrice.toFixed(2) %></span><br>                                                        <span class="text-success fw-bold">₹<%= item.salePrice.toFixed(2) %></span>                                                    <% } else { %>                                                        ₹<%= item.salePrice.toFixed(2) %>                                                    <% } %>                                                </td>                                                <td><%= item.quantity %></td>                                                <td>₹<%= (item.variant.salePrice * item.quantity).toFixed(2) %></td>                                                <td>                                                    <span class="badge variant-status-badge <%= item.status === 'delivered' ? 'bg-success' :                                                                        item.status === 'cancelled' ? 'bg-danger' :                                                                        item.status === 'shipped' ? 'bg-info' :                                                                        item.status === 'out for delivery' ? 'bg-primary' :                                                                        item.status === 'return pending' ? 'bg-warning' :                                                                        item.status === 'returned' ? 'bg-secondary' : 'bg-warning' %>"                                                          data-variant="<%= item.variant?.size || 'N/A' %>">                                                        <%= item.status.charAt(0).toUpperCase() + item.status.slice(1) %>                                                    </span>                                                </td>                                                <td>                                                    <% if (item.status === 'return pending') { %>                                                        <% if (item.product) { %>                                                            <button class="btn btn-sm btn-warning process-return-btn"                                                                    data-order-id="<%= order._id %>"                                                                    data-product-id="<%= item.product._id %>"                                                                    data-variant-size="<%= item.variant?.size || '' %>"                                                                    data-variant-index="<%= index %>"                                                                    data-product-name="<%= item.product.name %> (<%= item.variant?.size || 'N/A' %>)">                                                                Process Return                                                            </button>                                                        <% } else { %>                                                            <span class="badge bg-secondary">Product Deleted - Cannot Process Return</span>                                                        <% } %>                                                    <% } else if (item.status !== 'cancelled' && item.status !== 'delivered' && item.status !== 'returned') { %>                                                        <% if (item.product) { %>                                                            <button class="btn btn-sm btn-primary update-status-btn"                                                                    data-order-id="<%= order._id %>"                                                                    data-product-id="<%= item.product._id %>"                                                                    data-variant-size="<%= item.variant?.size || '' %>"                                                                    data-variant-index="<%= index %>"                                                                    data-current-status="<%= item.status %>"                                                                    title="Update status for <%= item.product.name %> (<%= item.variant?.size || 'N/A' %>)">                                                                Update Status                                                            </button>                                                        <% } else { %>                                                            <span class="badge bg-secondary">Product Deleted - Cannot Update Status</span>                                                        <% } %>                                                    <% } %>                                                </td>                                            </tr>                                            <% }); %>                                        </tbody>                                    </table>                                </div>                            </div>                        </div>                        <div class="card mb-4 shadow-sm">                            <div class="card-header bg-white">                                <h5 class="mb-0">Order Timeline</h5>                            </div>                            <div class="card-body">                                <div class="order-timeline">                                    <div class="timeline-item <%= orderStatus.placed ? 'completed' : '' %>">                                        <div class="timeline-icon">                                            <i class="fas fa-check-circle"></i>                                        </div>                                        <div class="timeline-content">                                            <h5>Order Placed</h5>                                            <p class="text-muted"><%= orderStatus.placedDate %></p>                                        </div>                                    </div>                                    <div class="timeline-item <%= orderStatus.processing ? 'completed' : '' %>">                                        <div class="timeline-icon">                                            <i class="fas <%= orderStatus.processing ? 'fa-check-circle' : 'fa-circle' %>"></i>                                        </div>                                        <div class="timeline-content">                                            <h5>Processing</h5>                                            <p class="text-muted"><%= orderStatus.processingDate || 'Pending' %></p>                                        </div>                                    </div>                                    <div class="timeline-item <%= orderStatus.shipped ? 'completed' : '' %>">                                        <div class="timeline-icon">                                            <i class="fas <%= orderStatus.shipped ? 'fa-check-circle' : 'fa-circle' %>"></i>                                        </div>                                        <div class="timeline-content">                                            <h5>Shipped</h5>                                            <p class="text-muted"><%= orderStatus.shippedDate || 'Pending' %></p>                                        </div>                                    </div>                                    <div class="timeline-item <%= orderStatus.outForDelivery ? 'completed' : '' %>">                                        <div class="timeline-icon">                                            <i class="fas <%= orderStatus.outForDelivery ? 'fa-check-circle' : 'fa-circle' %>"></i>                                        </div>                                        <div class="timeline-content">                                            <h5>Out for Delivery</h5>                                            <p class="text-muted"><%= orderStatus.outForDeliveryDate || 'Pending' %></p>                                        </div>                                    </div>                                    <div class="timeline-item <%= orderStatus.delivered ? 'completed' : '' %>">                                        <div class="timeline-icon">                                            <i class="fas <%= orderStatus.delivered ? 'fa-check-circle' : 'fa-circle' %>"></i>                                        </div>                                        <div class="timeline-content">                                            <h5>Delivered</h5>                                            <p class="text-muted"><%= orderStatus.deliveredDate || 'Pending' %></p>                                        </div>                                    </div>                                </div>                            </div>                        </div>                        <% if (order.trackingDetails && order.trackingDetails.updates && order.trackingDetails.updates.length > 0) { %>                        <div class="card mb-4 shadow-sm">                            <div class="card-header bg-white">                                <h5 class="mb-0">Tracking Updates</h5>                            </div>                            <div class="card-body">                                <div class="tracking-timeline">                                    <% order.trackingDetails.updates.slice().reverse().forEach(update => { %>                                    <div class="tracking-item">                                        <div class="tracking-date">                                            <%= new Date(update.timestamp).toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' }) %>                                            <span class="tracking-time"><%= new Date(update.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>                                        </div>                                        <div class="tracking-content">                                            <h5><%= update.status %></h5>                                            <p class="mb-0"><%= update.description %></p>                                            <% if (update.location) { %>                                            <p class="text-muted mb-0"><i class="fas fa-map-marker-alt me-1"></i> <%= update.location %></p>                                            <% } %>                                        </div>                                    </div>                                    <% }); %>                                </div>                            </div>                        </div>                        <% } %>                        <% if (order.products.some(p => p.status === 'return pending')) { %>                        <div class="alert alert-warning">                            <div class="d-flex align-items-center">                                <i class="fas fa-exclamation-triangle fs-4 me-3"></i>                                <div>                                    <h5 class="alert-heading mb-1">Return Requests Pending</h5>                                    <p class="mb-0">This order has pending return requests that need your attention.</p>                                </div>                            </div>                        </div>                        <% } %>                    </div>                </div>            </div>        </main>        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>        <script src="/js/admin-navbar.js"></script>        <script src="/js/admin-order-details.js"></script>    </body></html>