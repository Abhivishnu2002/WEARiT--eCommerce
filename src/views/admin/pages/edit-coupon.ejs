<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WEARiT - Edit Coupon</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="/css/admin-navbar.css">
    <link rel="stylesheet" href="/css/admin-coupon-form.css">
    <link rel="stylesheet" href="/css/toast-notifications.css">
</head>
<body>
    <%- include('../partials/navbar', {activePage: 'coupons'}) %>
    <main class="admin-main">
        <div class="admin-content">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin/dashboard" class="text-decoration-none">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/admin/coupons" class="text-decoration-none">Coupons</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Edit Coupon
                    </li>
                </ol>
            </nav>

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Edit Coupon: <span class="coupon-code-display"><%= coupon.code %></span></h5>
                    <span class="badge bg-<%= coupon.status === 'Active' ? 'success' : (coupon.status === 'Inactive' ? 'danger' : (coupon.status === 'Expired' ? 'warning' : 'info')) %>">
                        <%= coupon.status %>
                    </span>
                </div>
                <div class="card-body">
                    <form action="/admin/coupons/edit/<%= coupon._id %>" method="POST" id="couponForm" class="needs-validation" novalidate>
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Basic Information</h6>
                                    
                                    <div class="mb-3">
                                        <label for="code" class="form-label">Coupon Code</label>
                                        <input type="text" class="form-control" id="code" value="<%= coupon.code %>" readonly>
                                        <div class="form-text">Coupon code cannot be changed after creation.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe what this coupon is for" required><%= coupon.description %></textarea>
                                        <div class="invalid-feedback">Please enter a description.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label d-block">Status</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="isActive" name="isActive" <%= coupon.isActive ? 'checked' : '' %>>
                                            <label class="form-check-label" for="isActive">Active</label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Usage Statistics</label>
                                        <div class="usage-stats">
                                            <div class="usage-stat-item">
                                                <span class="stat-label">Used</span>
                                                <span class="stat-value"><%= coupon.usedCount %> times</span>
                                            </div>
                                            <div class="usage-stat-item">
                                                <span class="stat-label">Remaining</span>
                                                <span class="stat-value"><%= coupon.usageLimit - coupon.usedCount %> uses</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Discount Settings -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Discount Settings</h6>
                                    
                                    <div class="mb-3">
                                        <label for="discountType" class="form-label">Discount Type <span class="text-danger">*</span></label>
                                        <select class="form-select" id="discountType" name="discountType" required>
                                            <option value="">Select discount type</option>
                                            <option value="percentage" <%= coupon.discountType === 'percentage' ? 'selected' : '' %>>Percentage (%)</option>
                                            <option value="fixed" <%= coupon.discountType === 'fixed' ? 'selected' : '' %>>Fixed Amount (₹)</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a discount type.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="discountValue" class="form-label">Discount Value <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="discountValue" name="discountValue" min="1" step="0.01" value="<%= coupon.discountValue %>" required>
                                            <span class="input-group-text discount-symbol"><%= coupon.discountType === 'percentage' ? '%' : '₹' %></span>
                                        </div>
                                        <div class="invalid-feedback">Please enter a valid discount value.</div>
                                    </div>
                                    
                                    <div class="mb-3 max-discount-container <%= coupon.discountType !== 'percentage' ? 'd-none' : '' %>">
                                        <label for="maximumDiscount" class="form-label">Maximum Discount (₹)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="number" class="form-control" id="maximumDiscount" name="maximumDiscount" min="0" step="0.01" value="<%= coupon.maximumDiscount || '' %>">
                                        </div>
                                        <div class="form-text">Leave empty for no maximum limit.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="minimumPurchase" class="form-label">Minimum Purchase Amount (₹)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="number" class="form-control" id="minimumPurchase" name="minimumPurchase" min="0" step="0.01" value="<%= coupon.minimumPurchase %>">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Usage Limits -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Usage Limits</h6>
                                    
                                    <div class="mb-3">
                                        <label for="usageLimit" class="form-label">Total Usage Limit</label>
                                        <input type="number" class="form-control" id="usageLimit" name="usageLimit" min="<%= coupon.usedCount %>" value="<%= coupon.usageLimit %>">
                                        <div class="form-text">How many times this coupon can be used in total. Cannot be less than current usage count.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="startDate" class="form-label">Start Date <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control datepicker" id="startDate" name="startDate" value="<%= coupon.startDate %>" required>
                                        <div class="invalid-feedback">Please select a start date.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="endDate" class="form-label">End Date <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control datepicker" id="endDate" name="endDate" value="<%= coupon.endDate %>" required>
                                        <div class="invalid-feedback">Please select an end date.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Applicability -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Applicability</h6>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="userSpecific" name="userSpecific" <%= coupon.userSpecific ? 'checked' : '' %>>
                                            <label class="form-check-label" for="userSpecific">User Specific</label>
                                        </div>
                                        <div class="form-text">If enabled, coupon will only be applicable to selected users.</div>
                                    </div>
                                    
                                    <div class="mb-3 user-select-container <%= !coupon.userSpecific ? 'd-none' : '' %>">
                                        <label for="applicableUsers" class="form-label">Select Users</label>
                                        <select class="form-select select2" id="applicableUsers" name="applicableUsers" multiple>
                                            <% if (locals.users && users.length > 0) { %>
                                                <% users.forEach(user => { %>
                                                    <option value="<%= user._id %>" 
                                                        <%= coupon.applicableUsers && coupon.applicableUsers.some(id => id.toString() === user._id.toString()) ? 'selected' : '' %>>
                                                        <%= user.name %> (<%= user.email %>)
                                                    </option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="applicableCategories" class="form-label">Applicable Categories</label>
                                        <select class="form-select select2" id="applicableCategories" name="applicableCategories" multiple>
                                            <% if (locals.categories && categories.length > 0) { %>
                                                <% categories.forEach(category => { %>
                                                    <option value="<%= category._id %>"
                                                        <%= coupon.applicableCategories && coupon.applicableCategories.some(id => id.toString() === category._id.toString()) ? 'selected' : '' %>>
                                                        <%= category.name %>
                                                    </option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                        <div class="form-text">Leave empty to apply to all categories.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="applicableProducts" class="form-label">Applicable Products</label>
                                        <select class="form-select select2" id="applicableProducts" name="applicableProducts" multiple>
                                            <% if (locals.products && products.length > 0) { %>
                                                <% products.forEach(product => { %>
                                                    <option value="<%= product._id %>"
                                                        <%= coupon.applicableProducts && coupon.applicableProducts.some(id => id.toString() === product._id.toString()) ? 'selected' : '' %>>
                                                        <%= product.name %>
                                                    </option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                        <div class="form-text">Leave empty to apply to all products.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <a href="/admin/coupons" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Update Coupon</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="/js/admin-navbar.js"></script>
    <script src="/js/toast-notifications.js"></script>
    <script src="/js/admin-toast-handler.js"></script>
    <script src="/js/admin-coupon-form.js"></script>
</body>
</html>
