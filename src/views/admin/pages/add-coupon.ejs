<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WEARiT - Add New Coupon</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="/css/admin-navbar.css">
    <link rel="stylesheet" href="/css/admin-coupon-form.css">
    <link rel="stylesheet" href="/css/toast-notifications.css">
</head>
<body>
    <%- include('../partials/navbar', {activePage: 'coupons'}) %>
    <main class="admin-main">
        <div class="admin-content">
            <% if (locals.error_msg) { %>
                <div class="alert alert-danger alert-dismissible fade show d-none" role="alert">
                    <%= error_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin/dashboard" class="text-decoration-none">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/admin/coupons" class="text-decoration-none">Coupons</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Add New Coupon
                    </li>
                </ol>
            </nav>

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0">Add New Coupon</h5>
                </div>
                <div class="card-body">
                    <form action="/admin/coupons/add" method="POST" id="couponForm" class="needs-validation" novalidate>
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Basic Information</h6>
                                    
                                    <div class="mb-3">
                                        <label for="code" class="form-label">Coupon Code <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="code" name="code" placeholder="e.g. SUMMER2023" required>
                                            <button class="btn btn-outline-secondary" type="button" id="generateCodeBtn">
                                                <i class="fas fa-dice me-1"></i> Generate
                                            </button>
                                        </div>
                                        <div class="form-text">Coupon code will be automatically converted to uppercase.</div>
                                        <div class="invalid-feedback">Please enter a coupon code.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe what this coupon is for" required></textarea>
                                        <div class="invalid-feedback">Please enter a description.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label d-block">Status</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                                            <label class="form-check-label" for="isActive">Active</label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoExpire" name="autoExpire" checked>
                                            <label class="form-check-label" for="autoExpire">Auto-expire when usage limit is reached</label>
                                        </div>
                                        <div class="form-text">When enabled, the coupon will automatically become inactive once it reaches its usage limit.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Discount Settings -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Discount Settings</h6>
                                    
                                    <div class="mb-3">
                                        <label for="discountType" class="form-label">Discount Type <span class="text-danger">*</span></label>
                                        <select class="form-select" id="discountType" name="discountType" required>
                                            <option value="">Select discount type</option>
                                            <option value="percentage">Percentage (%)</option>
                                            <option value="fixed">Fixed Amount (₹)</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a discount type.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="discountValue" class="form-label">
                                            Discount Value <span class="text-danger">*</span>
                                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                                               title="For fixed discounts: Must be less than minimum purchase amount. For percentage: 1-100%"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="discountValue" name="discountValue" min="1" step="0.01" required>
                                            <span class="input-group-text discount-symbol">%</span>
                                        </div>
                                        <div class="invalid-feedback" id="discountValue-error">Please enter a valid discount value.</div>
                                    </div>
                                    
                                    <div class="mb-3 max-discount-container d-none">
                                        <label for="maximumDiscount" class="form-label">
                                            Maximum Discount (₹)
                                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                                               title="Must be less than minimum purchase amount if set"></i>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="number" class="form-control" id="maximumDiscount" name="maximumDiscount" min="0" step="0.01">
                                        </div>
                                        <div class="invalid-feedback" id="maximumDiscount-error"></div>
                                        <div class="form-text">Leave empty for no maximum limit.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="minimumPurchase" class="form-label">
                                            Minimum Purchase Amount (₹)
                                            <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip"
                                               title="Must be greater than discount value (for fixed) or maximum discount (for percentage)"></i>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="number" class="form-control" id="minimumPurchase" name="minimumPurchase" min="0" step="0.01" value="0">
                                        </div>
                                        <div class="invalid-feedback" id="minimumPurchase-error"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Usage Limits -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Usage Limits</h6>
                                    
                                    <div class="mb-3">
                                        <label for="usageLimit" class="form-label">Total Usage Limit <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="usageLimit" name="usageLimit" min="1" value="1" required>
                                        <div class="form-text">How many times this coupon can be used in total.</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="perUserLimit" class="form-label">Per User Limit</label>
                                        <input type="number" class="form-control" id="perUserLimit" name="perUserLimit" min="1" value="1">
                                        <div class="form-text">Maximum number of times a single user can use this coupon.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="startDate" class="form-label">Start Date <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control datepicker" id="startDate" name="startDate" placeholder="Select start date" required>
                                        <div class="invalid-feedback">Please select a start date.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="endDate" class="form-label">End Date <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control datepicker" id="endDate" name="endDate" placeholder="Select end date" required>
                                        <div class="invalid-feedback">Please select an end date.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Applicability -->
                            <div class="col-md-6 mb-4">
                                <div class="form-section">
                                    <h6 class="section-title">Applicability</h6>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="userSpecific" name="userSpecific">
                                            <label class="form-check-label" for="userSpecific">User Specific</label>
                                        </div>
                                        <div class="form-text">If enabled, coupon will only be applicable to selected users.</div>
                                    </div>
                                    
                                    <div class="mb-3 user-select-container d-none">
                                        <label for="applicableUsers" class="form-label">Select Users</label>
                                        <select class="form-select select2" id="applicableUsers" name="applicableUsers" multiple>
                                            <% if (locals.users && users.length > 0) { %>
                                                <% users.forEach(user => { %>
                                                    <option value="<%= user._id %>"><%= user.name %> (<%= user.email %>)</option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="applicableCategories" class="form-label">Applicable Categories</label>
                                        <select class="form-select select2" id="applicableCategories" name="applicableCategories" multiple>
                                            <% if (locals.categories && categories.length > 0) { %>
                                                <% categories.forEach(category => { %>
                                                    <option value="<%= category._id %>"><%= category.name %></option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                        <div class="form-text">Leave empty to apply to all categories.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="applicableProducts" class="form-label">Applicable Products</label>
                                        <select class="form-select select2" id="applicableProducts" name="applicableProducts" multiple>
                                            <% if (locals.products && products.length > 0) { %>
                                                <% products.forEach(product => { %>
                                                    <option value="<%= product._id %>"><%= product.name %></option>
                                                <% }) %>
                                            <% } %>
                                        </select>
                                        <div class="form-text">Leave empty to apply to all products.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <a href="/admin/coupons" class="btn btn-secondary">Cancel</a>
                            <button type="button" id="previewCouponBtn" class="btn btn-outline-primary">
                                <i class="fas fa-eye me-1"></i> Preview
                            </button>
                            <button type="submit" class="btn btn-primary">Create Coupon</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="/js/admin-navbar.js"></script>
    <script src="/js/toast-notifications.js"></script>
    <script src="/js/admin-coupon-form.js"></script>
</body>
</html>
