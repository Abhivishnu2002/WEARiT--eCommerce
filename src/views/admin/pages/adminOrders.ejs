<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEARiT - Orders Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="/css/admin-navbar.css">
    <link rel="stylesheet" href="/css/admin-orders.css">
</head>
<body>
    <%- include('../partials/navbar', {activePage: 'orders'}) %>
    
    <main class="admin-main">
        <div class="admin-content">
            <% if (locals.success_msg && success_msg.length > 0) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <%= success_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <% if (locals.error_msg && error_msg.length > 0) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= error_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin/dashboard" class="text-decoration-none">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Orders</li>
                </ol>
            </nav>

            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 breadcrumb-section">
                <h2 class="mb-0">Orders Management</h2>
                <div class="header-stats">
                    <div class="stat-card">
                        <div class="stat-value"><%= totalOrders %></div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Filter Section -->
            <div class="filters-container mb-4">
                <div class="filters-header">
                    <h5 class="filters-title">
                        <i class="fas fa-filter me-2"></i>
                        Filters & Search
                    </h5>
                    <button class="filters-toggle" onclick="toggleFilters()">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>

                <div class="filters-content" id="filtersContent">
                    <!-- Search Section -->
                    <div class="filter-section">
                        <div class="section-header">
                            <i class="fas fa-search section-icon"></i>
                            <span class="section-title">Search Orders</span>
                        </div>
                        <div class="search-container">
                            <div class="input-group" style="max-width: 500px">
                                <input type="text" 
                                       id="searchOrder" 
                                       class="form-control"
                                       placeholder="Search by Order ID, Customer Name, or Email..." 
                                       value="<%= query.search || '' %>">
                                <button class="btn btn-primary" onclick="performSearch()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Time Period Filter -->
                    <div class="filter-section">
                        <div class="section-header">
                            <i class="fas fa-calendar-alt section-icon"></i>
                            <span class="section-title">Time Period</span>
                        </div>
                        <div class="filter-grid">
                            <button class="btn filter-chip <%= !query.timeFilter ? 'btn-primary' : 'btn-outline-secondary' %>" 
                                    onclick="applyTimeFilter('')">
                                <i class="fas fa-infinity me-2"></i>All Time
                            </button>
                            <button class="btn filter-chip <%= query.timeFilter === '24hour' ? 'btn-primary' : 'btn-outline-secondary' %>" 
                                    onclick="applyTimeFilter('24hour')">
                                <i class="fas fa-clock me-2"></i>Last 24 Hours
                            </button>
                            <button class="btn filter-chip <%= query.timeFilter === '7days' ? 'btn-primary' : 'btn-outline-secondary' %>" 
                                    onclick="applyTimeFilter('7days')">
                                <i class="fas fa-calendar-week me-2"></i>Last 7 Days
                            </button>
                            <button class="btn filter-chip <%= query.timeFilter === '30days' ? 'btn-primary' : 'btn-outline-secondary' %>" 
                                    onclick="applyTimeFilter('30days')">
                                <i class="fas fa-calendar-day me-2"></i>Last 30 Days
                            </button>
                            <button class="btn filter-chip <%= query.timeFilter === '12months' ? 'btn-primary' : 'btn-outline-secondary' %>" 
                                    onclick="applyTimeFilter('12months')">
                                <i class="fas fa-calendar me-2"></i>Last 12 Months
                            </button>
                        </div>
                    </div>

                    <!-- Status & Payment Filters -->
                    <div class="filter-section">
                        <div class="section-header">
                            <i class="fas fa-tags section-icon"></i>
                            <span class="section-title">Status & Payment</span>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Order Status</label>
                                <select id="statusFilter" class="form-select" onchange="applyStatusFilter(this.value)">
                                    <option value="">All Statuses</option>
                                    <option value="pending" <%= query.status === 'pending' ? 'selected' : '' %>>Pending</option>
                                    <option value="processing" <%= query.status === 'processing' ? 'selected' : '' %>>Processing</option>
                                    <option value="shipped" <%= query.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                                    <option value="out for delivery" <%= query.status === 'out for delivery' ? 'selected' : '' %>>Out for Delivery</option>
                                    <option value="delivered" <%= query.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                                    <option value="cancelled" <%= query.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Payment Method</label>
                                <select id="paymentFilter" class="form-select" onchange="applyPaymentFilter(this.value)">
                                    <option value="">All Payment Methods</option>
                                    <% paymentMethods.forEach(method => { %>
                                        <option value="<%= method %>" <%= query.paymentMethod === method ? 'selected' : '' %>>
                                            <%= method.toUpperCase() %>
                                        </option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Return Status</label>
                                <select id="returnFilter" class="form-select" onchange="applyReturnFilter(this.value)">
                                    <option value="">All Returns</option>
                                    <option value="return pending" <%= query.returnStatus === 'return pending' ? 'selected' : '' %>>Return Pending</option>
                                    <option value="returned" <%= query.returnStatus === 'returned' ? 'selected' : '' %>>Returned</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Actions -->
                    <div class="filter-actions">
                        <button class="btn btn-outline-secondary" onclick="clearAllFilters()">
                            <i class="fas fa-times me-2"></i>Clear All Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div class="active-filters mb-3" id="activeFilters" style="display: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Active Filters:</span>
                    <button class="btn btn-sm btn-outline-warning" onclick="clearAllFilters()">
                        <i class="fas fa-times me-1"></i>Clear All
                    </button>
                </div>
                <div class="active-filters-list mt-2" id="activeFiltersList">
                    <!-- Active filters will be populated by JavaScript -->
                </div>
            </div>

            <!-- Orders Table -->
            <div class="table-responsive product-table mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Orders List</h5>
                        <small class="text-muted">
                            <%= totalOrders %> order<%= totalOrders !== 1 ? 's' : '' %> found
                        </small>
                    </div>
                    <div class="d-flex align-items-center">
                        <label for="sortSelect" class="form-label me-2 mb-0">Sort by:</label>
                        <select id="sortSelect" class="form-select form-select-sm" onchange="applySorting(this.value)" style="width: auto;">
                            <option value="orderDate-desc" <%= (!query.sortBy || query.sortBy === 'orderDate') && query.sortOrder === 'desc' ? 'selected' : '' %>>
                                Newest First
                            </option>
                            <option value="orderDate-asc" <%= query.sortBy === 'orderDate' && query.sortOrder === 'asc' ? 'selected' : '' %>>
                                Oldest First
                            </option>
                            <option value="finalAmount-desc" <%= query.sortBy === 'finalAmount' && query.sortOrder === 'desc' ? 'selected' : '' %>>
                                Highest Amount
                            </option>
                            <option value="finalAmount-asc" <%= query.sortBy === 'finalAmount' && query.sortOrder === 'asc' ? 'selected' : '' %>>
                                Lowest Amount
                            </option>
                        </select>
                    </div>
                </div>

                <% if (orders && orders.length > 0) { %>
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('orderID')">
                                    Order ID <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th class="sortable" onclick="sortTable('orderDate')">
                                    Date <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th>Customer</th>
                                <th class="sortable" onclick="sortTable('finalAmount')">
                                    Total <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th>Payment</th>
                                <th class="sortable" onclick="sortTable('orderStatus')">
                                    Status <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% orders.forEach(order => { %>
                                <tr class="order-row">
                                    <td>
                                        <span class="order-id fw-bold text-primary">#<%= order.orderID %></span>
                                    </td>
                                    <td>
                                        <div class="date-info">
                                            <div class="fw-semibold">
                                                <%= new Date(order.orderDate).toLocaleDateString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric',
                                                    year: 'numeric'
                                                }) %>
                                            </div>
                                            <small class="text-muted">
                                                <%= new Date(order.orderDate).toLocaleTimeString('en-US', { 
                                                    hour: '2-digit', 
                                                    minute: '2-digit'
                                                }) %>
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="customer-info">
                                            <div class="fw-semibold">
                                                <%= order.user && order.user.name ? order.user.name : 'Unknown User' %>
                                            </div>
                                            <small class="text-muted">
                                                <%= order.user && order.user.email ? order.user.email : 'N/A' %>
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-success">
                                            â‚¹<%= order.finalAmount ? order.finalAmount.toLocaleString('en-IN') : '0' %>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="payment-method">
                                            <% if (order.paymentMethod === 'COD') { %>
                                                <i class="fas fa-money-bill-wave text-warning me-1"></i>
                                            <% } else if (order.paymentMethod === 'online') { %>
                                                <i class="fas fa-credit-card text-info me-1"></i>
                                            <% } else if (order.paymentMethod === 'paypal') { %>
                                                <i class="fab fa-paypal text-primary me-1"></i>
                                            <% } else { %>
                                                <i class="fas fa-wallet text-secondary me-1"></i>
                                            <% } %>
                                            <small class="fw-medium">
                                                <%= order.paymentMethod ? order.paymentMethod.toUpperCase() : 'N/A' %>
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge status-badge status-<%= order.orderStatus ? order.orderStatus.replace(/\s+/g, '-') : 'unknown' %>">
                                            <% if (order.orderStatus === 'pending') { %>
                                                <i class="fas fa-clock me-1"></i>
                                            <% } else if (order.orderStatus === 'processing') { %>
                                                <i class="fas fa-cog me-1"></i>
                                            <% } else if (order.orderStatus === 'shipped') { %>
                                                <i class="fas fa-shipping-fast me-1"></i>
                                            <% } else if (order.orderStatus === 'delivered') { %>
                                                <i class="fas fa-check-circle me-1"></i>
                                            <% } else if (order.orderStatus === 'cancelled') { %>
                                                <i class="fas fa-times-circle me-1"></i>
                                            <% } %>
                                            <%= order.orderStatus ? order.orderStatus.charAt(0).toUpperCase() + order.orderStatus.slice(1) : 'Unknown' %>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="/admin/orders/<%= order._id %>" class="action-btn btn btn-sm btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="action-btn btn btn-sm btn-outline-success edit-btn" data-order-id="<%= order._id %>" title="Update Status">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Orders Found</h5>
                        <p class="text-muted">No orders match your current filter criteria.</p>
                        <button class="btn btn-primary" onclick="clearAllFilters()">
                            <i class="fas fa-refresh me-2"></i>Reset Filters
                        </button>
                    </div>
                <% } %>
            </div>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-0">
                            Showing <%= ((currentPage - 1) * limit) + 1 %>-<%= Math.min(currentPage * limit, totalOrders) %> of <%= totalOrders %> orders
                        </p>
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                            <li class="page-item <%= currentPage <= 1 ? 'disabled' : '' %>">
                                <a class="page-link" href="#" onclick="goToPage(<%= currentPage - 1 %>)" aria-label="Previous">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            
                            <% 
                                let startPage = Math.max(1, currentPage - 2);
                                let endPage = Math.min(totalPages, currentPage + 2);
                                
                                if (startPage > 1) { 
                            %>
                                <li class="page-item">
                                    <a class="page-link" href="#" onclick="goToPage(1)">1</a>
                                </li>
                                <% if (startPage > 2) { %>
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                <% } %>
                            <% } %>
                            
                            <% for (let i = startPage; i <= endPage; i++) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="#" onclick="goToPage(<%= i %>)">
                                        <%= i %>
                                    </a>
                                </li>
                            <% } %>
                            
                            <% if (endPage < totalPages) { %>
                                <% if (endPage < totalPages - 1) { %>
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                <% } %>
                                <li class="page-item">
                                    <a class="page-link" href="#" onclick="goToPage(<%= totalPages %>)">
                                        <%= totalPages %>
                                    </a>
                                </li>
                            <% } %>
                            
                            <li class="page-item <%= currentPage >= totalPages ? 'disabled' : '' %>">
                                <a class="page-link" href="#" onclick="goToPage(<%= currentPage + 1 %>)" aria-label="Next">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            <% } %>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="/js/admin-navbar.js"></script>
    <script src="/js/admin-orders.js"></script>
</body>
</html>
